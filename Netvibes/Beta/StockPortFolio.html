<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:widget="http://www.netvibes.com/ns/" >
  <head>
    <meta name="author" content="Christian Nybroe" />
    <meta name="email" content="netvibes_stock+cnybroe@gmail.com" />
    <meta name="website" content="http://Netvibes.cnybroe.dk" />
    <meta name="screenshot" content="http://Netvibes.cnybroe.dk/images/StockPortfolio.png" />
    <meta name="thumbnail" content="http://Netvibes.cnybroe.dk/images/StockPortfolioThumb.png" />
    <meta name="description" content="Highly configurable list with unlimited number of stocks, options, ETFs. See chart and details for each stock. Calculate total value, earning and much more" />
    <meta name="version" content="0.1&alpha;" />
    <meta name="keywords" content="stocks, quotes, quote, portfolio, finance" />
    <meta name="apiVersion" content="1.0" />
    <meta name="inline" content="true" />
    <meta name="debugMode" content="true" />
 
    <link rel="icon" type="image/png" href="http://www.netvibes.com/favicon.ico" />
    <link rel="stylesheet" type="text/css" href="http://www.netvibes.com/themes/uwa/style.css" />
    <script type="text/javascript" src="http://www.netvibes.com/js/UWA/load.js.php?env=Standalone"></script>
    <title>Stock Portfolio</title>
    
    <widget:preferences>	
        <preference name="CustomTitle" ltype="text" abel="Custom title" defaultValue="Stock portfolio" onchange="refresh"/>
        <preference name="Flashing" type="boolean" label="Flash when value change" defaultValue="true" />

        <!-- Hidden preferences -->
        <preference name="GadgetVersion" type="hidden" defaultValue="0"/>
        <preference name="StockSymbols" type="text" label="Symbols" defaultValue="GOOG,MSFT"/>
        <preference name="StockQtys" type="text" defaultValue="1,1"/>
        <preference name="StockPrices" type="text" defaultValue="0,0"/>
        <preference name="StockTC" type="text" defaultValue="0,0"/>
        <preference name="StockHi" type="text" defaultValue="1000,1000"/>
        <preference name="StockLo" type="text" defaultValue="0,0"/>
        <preference name="StockExRate" type="text" defaultValue="1,1"/>
    </widget:preferences>
 
    <!-- Widget Styles -->
    <style type="text/css">
      .Loading{font-family:sans-serif;font-style:italic;font-size:11px;}
      .Footer{font-size:9px;font-family:sans-serif;padding:0px;margin:0px;}
      .HrDef{height:1px;margin-top:1px;margin-bottom:1px;margin-right:0px;margin-left:0px;}
    </style>

    <!-- Widget Code -->
    <script type="text/javascript">

      var GUI = {};
      var Quote = {};
      var myPortfolio = new Portfolio();
      //http://dev.netvibes.com/doc/uwa/howto/localize_widget(It's not quite ready yet, but we plan to release a way for widget developers to make their widget strings available to translator worldwide, which will free you from having to rely on a server-side script.)

    //Start of Portfolio Object:
    function Portfolio() {
        this.toString = function() {return this.stocks.length+1;};
        this.stocks = [];// New Array
        this.addStock = function(symbol,price,qty,tc,lo,hi,exRate,stockdata){var id=this.stocks.length+1; this.stocks.push(new Stock(id,symbol,price,qty,tc,lo,hi,exRate,stockdata));return id;};
        this.totalValue=function(){var v=0;for(var i=0;i<this.stocks.length;i++){v+=this.stocks[i].value();};return v;};
        this.readPreferences=readPreferences;
    }
    function readPreferences() {
        print ('readPreferences started');
        alert(widget.getValue('StockSymbols'));
        //var ss = widget.getValue('StockSymbols').split(',');
        //var sp = widget.getValue('StockPrices').split(',');
        //var sq = widget.getValue('StockQtys').split(',');
        //var st = widget.getValue('StockTC').split(',');
        //var sl = widget.getValue('StockLo').split(',');
        //var sh = widget.getValue('StockHi').split(',');
        //var se = widget.getValue('StockExRate').split(',');
          
        //for (var i=0;i<ss.length;i++) {
        //    this.addStock(ss[i],sp[i],sq[i],st[i],sl[i],sh[i],se[i]);
        //}
        print ('readPreferences ended');
    }
    //End of Portfolio object

    //Start of Stock Object:
    function Stock(id,symbol,price,qty,tc,lo,hi,exRate) {
        this.id = id;
        this.symbol = symbol;
        this.price = price;
        this.qty = qty;
        this.tradeCost = tc;
        this.hi = hi;
        this.lo = lo;
        this.exRate = exRate;
        //Stockdata Properties
        this.updateStockData = function(stockdata) {
            var s = parseStockData(stockdata); 
            this.description = s[2];
            this.changePct = s[3];
            this.change = s[4];
            this.changeRange = s[5];
            this.lastTrade = s[6];
            this.lastTradeDate = s[7];
            this.lastTradeTime = s[8];
            this.dayopen = s[9];
            this.dayLow = s[10];
            this.dayHigh = s[11];
            this.dayVolume = s[12];
            this.previousClose = s[13];
            this.fiftyTwoWeekRange = s[14];
            this.ask = s[15];
            this.bid = s[16];
            this.tickerTrend = s[17];
            this.fiftyDaysMovingAvg = s[18];
            this.twoHundredDaysMovingAvg = s[19];
            this.dayRange = s[20];
            this.optionStrike = s[21];
            this.OptionCallPut = s[22];
            this.OptionExpire = s[23];
            this.currency = s[24];
            this.exchange = s[25];
        };
        this.updateStockData(','); //Initialize stockdata properties with dummy values
        
        this.value = function(){return this.qty*this.lastTrade*this.exRate;};
        this.totalBuyCosts = function(){return myRoundD(parseFloat(this.price*this.exRate*this.qty)+parseFloat(this.tradeCost),0);}; //Total costs in local currency
        this.profit = function(){return myRoundD((this.lastTrade.replace("%","")*this.exRate*this.qty)-this.totalBuyCosts(),0);};
        this.profitPct = function(){return myRoundD(((this.value() / this.totalBuyCosts())-1)*100,0);};
        this.profitToday = function(){return (isNaN(this.change))?0:myRoundD(this.change*this.qty*this.exRate,0);};
        this.profitTodayPct = function(){return (isNaN(this.changePct.replace(/\%/g,"").replace(/\+/g,"").replace(/\-/g,"")))?0:myRoundD(this.changePct.replace(/\%/g,""),0);};
        //Stock object Event triggers
        if (this.last>this.hi){onStockHi(this.id);}
        if (this.last<this.lo){onStockLo(this.id);}
    }

    //Stock object Events
    function onStockHi(id) {
        print('Hi limit passed on index: '+id);
    }
    function onStockLo(id) {
        print('Lo limit passed on index: '+id);
    }
    function parseStockData(inp) {
        var out=[];
        out=inp.split(/,(?=(?:[^\"]*\"[^\"]*\")*(?![^\"]*\"))/);
        for(var i=0;i<out.length;i++) {
          out[i]=out[i].replace(/"/g,"");
        }
        if(out.length!=26) {
            out='N/A,Bad data,Bad data,0.00%,0.00,0.00 - 0.00%,0.00,01/01/1899,12:00am,0.00,0.00,0.00,100000,0.00,"0.00 - 0.00",0.00,0.00," ====== ",+0.00%,0.00%,"0.00 - 0.00","N/A","N/A","N/A","EUR","No exchange"'.split(',');	
        }
        if(out[0]!="N/A") {
          out[24]="???";
          out[25]=out[0].substr(0,out[0].indexOf("<"));
        }
        return out;
    }
//End of Stock object

      
//GUI object
      GUI.imgBase = "http://Netvibes.cnybroe.dk/images/";
      GUI.debug=0;
      GUI.insertFooter = function() {return widget.body.getElementById("Footer").innerHTML='<table border="0" cellspacing="0" celpadding="1px" width="100%"><tr><td colspan="7" style="height:2px"></td></tr><tr class="Footer"><td id="FooterMsg" nowrap>'+_('Loading stocks...')+'</td><td width="18px"><img id="AddEditIcon" width="16" height="16" style="border:none;cursor:pointer;" onclick="fnToggleAdd(0)" src="' + GUI.imgBase + 'AddEdit.gif" title="'+_('Show add/edit dialog')+'"></td><td style="width:18px;"><img width="16" height="16" style="border:none;cursor:pointer" onclick="fnToggleSummary(1)" src="' + GUI.imgBase + 'Summary.gif" title="'+_('Show stock summary')+'"></td><td style="width:18px;"><img width="16" height="16" style="border:none;cursor:pointer;" onclick="fnToggleProfit(false)" src="' + GUI.imgBase + 'money.gif" title='+_('Show profit details')+'"></td><td style="width:18px;"><img width="16" height="16" style="border:none;cursor:pointer;" onclick="fnToggleNews(1);" src="' + GUI.imgBase + 'News.gif" title="'+_('Show news')+'"/></td><td style="width:18px;"><a href="http://sites.google.com/site/cnybroe/iGoogleStockGadget/help-1" target="_blank"><img width="16" height="16" style="border:none;cursor:pointer;" src="' + GUI.imgBase + 'help.gif" title="'+_('Help')+'"></a></td><td style="width:18px;"><a href="http://ggforum.cnybroe.dk/default.aspx?g=forum&c=2" target="_blank"><img width="16" height="16" style="border:none;cursor:pointer;" src="' + GUI.imgBase + 'ggroups.gif" title="'+_('Discuss this gadget with the developer and other users')+'"></a></td></tr></table>';};
      GUI.setAnalytics = function() {var _gaq = _gaq || [];_gaq.push(['_setAccount', 'UA-2031644-3']);_gaq.push(['_trackPageview']);(function() {var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true; ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js'; var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);})();};
      GUI.myRoundD  = function (inp,digits) {var x=Math.pow(10,digits); return Math.round(inp*x)/x;};
      GUI.refreshGUI = function () {
          widget.setTitle(widget.getValue('CustomTitle'));
      };
      
//Quote object
      Quote.refreshData = function () {
          var tags='e1snp2c1cl1d1t1oghvpwabt7m8m6ms3p3e3c4x';
          var symbols='';// = widget.getValue('Symbols');
          
          for (var i=0;i<myPortfolio.stocks.length;i++) {
              symbols+=myPortfolio.stocks[i].symbol+',';
          }
          symbols = symbols.substr(0,symbols.length-1);
          print(symbols);
          
          var url='http://download.finance.yahoo.com/d?s=' + symbols + '&f=' + tags + '&CW=' + Math.random() * 1000;
          UWA.Data.getText(url,Quote.stockDataProxy);
      };
      Quote.stockDataProxy = function(stockData) {
          var sLines = [];
          sLines=stockData.split('\r\n');
          for (var i=0;i<myPortfolio.stocks.length;i++) {
            myPortfolio.stocks[i].updateStockData(sLines[i]);
          }       

        for (var i=0;i<myPortfolio.stocks.length;i++) {
          print(myPortfolio.stocks[i].symbol + ', Qty:' + myPortfolio.stocks[i].qty + ', Price:' + myPortfolio.stocks[i].price + ', TC:' + myPortfolio.stocks[i].tradeCost + ', exRate:' + myPortfolio.stocks[i].exRate + ', Last:' + myPortfolio.stocks[i].lastTrade);
        }
        print('Total portfolio value:' + myPortfolio.totalValue());
          
      };

      
      <!-- Widget Events -->
      widget.onLoad = function() {
        //widget.body.getElementById('StockData').innerHTML=_('Loading...');
        GUI.insertFooter();
        //Test code
        myPortfolio.readPreferences();

        Quote.refreshData();        
        

        GUI.refreshGUI();
        GUI.setAnalytics();
      }
      
      widget.onRefresh = function(){
        GUI.refreshGUI();
      }
      
  // function fnInsertStockTable(){
    // var sBGColor;
    // var sStockTable='<table border=0 cellspacing=0 width="100%" style="font-size:'+fsize+';" class="def">';
    // var arrHeaderNames=',,,%,__MSG_change__,__MSG_change__(%),__MSG_lasttrade__,__MSG_lasttradedate__,__MSG_lasttradetime__,__MSG_dayopen__,__MSG_daylow__,__MSG_dayhigh__,__MSG_dayvolume__,__MSG_previousclose__,__MSG_52weekrange__,__MSG_ask__,__MSG_bid__,__MSG_tickertrend__,__MSG_50daymovingavg__,__MSG_200daymovingavg__,__MSG_dayrange__,__MSG_optionstrike__,__MSG_optioncallput__,__MSG_optionexpire__,__MSG_currency__,,__MSG_currencyrate__,,,,__MSG_dayearned__,__MSG_earned__,,,,__MSG_buyprice__'.split(",");
    // var sHead="";
    // iConfCols=0;
    // for(i=1;i<iStockCols+1;i++){
      // if(pref.getString("Column"+i)!='0'){
        // iConfCols++;
        // sHead+='<td class="cellR">'+arrHeaderNames[pref.getString("Column"+i)]+'</td>';
      // }
    // }
    // sStockTable+='<COLGROUP width="8px"><COLGROUP span="2" width="10%"><COLGROUP span="'+iConfCols+'" width="'+80/iConfCols+'%"><tr style="font-weight: bold;"><td style="padding-right:8px" title="Alerts"></td><td class="cellL">__MSG_name__</td><td class="cellR"><div class="Chart" id="StockChart"></div>__MSG_change__</td>';
    // sStockTable+=sHead;
    // sStockTable+='</tr><tr style="height:1px;background-Color:BCBCBC"><td colspan='+Number(iConfCols+3)+'></td></tr>';
    // for(i=0;i<arrStockSymbols.length;i++){
      // if(i%2==0){sBGColor='#FFFFFF';}else{sBGColor='#EFEFEF';}
      // sStockTable+='<tr id="str'+i+'" style="background-Color:'+sBGColor+';"><td class="cellL" id="stc'+i+'0"></td><td class="cellL" id="stc'+i+'1">'+arrStockSymbols[i]+'</td>';
      // for(j=2;j<iConfCols+3;j++){
        // sStockTable+='<td class="cellR" id="stc'+i+j+'"></td>';
      // }
      // sStockTable+='</tr>';
    // }
    // sStockTable+='</table>';
    // document.getElementById("StockData").innerHTML=sStockTable;
  // }
      
      
      
      


  //------------DEBUG CODE START-------------------
    function fngetDate(secs) {
      var currentTime=new Date();
      var month=fnZeroPad(currentTime.getMonth()+1,2);
      var day=fnZeroPad(currentTime.getDate(),2);
      var year=currentTime.getFullYear();
      var hours=fnZeroPad(currentTime.getHours(),2);
      var minutes=fnZeroPad(currentTime.getMinutes(),2);
      if(secs){minutes+=':'+fnZeroPad(currentTime.getSeconds(),2);}
      return year+'-'+month+'-'+day+' '+hours+':'+minutes;
    }
    function fnZeroPad(num,length) {
      var snum = num + '';
      while(snum.length < length) {
        snum = '0' + snum; 
      }
      return snum;
    }
    function print(msg) {
        var debug_html=document.getElementById("debug").innerHTML;
        var msg=fngetDate(1)+"; "+ msg.toString()+"<br>";
        debug_html=msg+debug_html;
        document.getElementById("debug").innerHTML=debug_html;
    }
  //------------DEBUG CODE END-------------------
      
    </script>
  </head>
	<!-- Widget HTML -->
  <body>
	  <div id="StockData"><div class="Loading">Loading</div></div>
	  <div id="Footer" class="Footer"></div>
	  <div id="disclaimer" nowrap><hr class="HrDef"><table border=0 cellspacing=0 cellpadding=0 width="100%"><tr><td valign="middle" class="Footer" nowrap width="10%"><a href="http://sites.google.com/site/cnybroe/iGoogleStockGadget/disclaimer" target="_blank">Stock data, news and historical charts provided by </a></td><td>&nbsp;<img width="93" height="10" border=0 alt="Yahoo Finance" title="Yahoo Finance" src="images\Y!FinanceLogo10.png"></td></tr></table></div>
	  <div id="debug" nowrap style="display:block;font-size:8pt;padding:5px;color:red;width:100%;height:200px;overflow:scroll"></div> 
  </body>
</html>